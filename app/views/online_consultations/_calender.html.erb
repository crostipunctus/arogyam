<table class="calendar-table">
  <% @calendar_start.upto(@calendar_end) do |date| %>
    <% date_booking_dates = @booking_dates.select { |bd| bd.date == date } %>

    <% if date_booking_dates.any? %>
      <% if date.wday == 1 %>
        <tr>
      <% end %>

      <td class="<%= 'calendar-current-date' if date == Date.today %>">
        <div class="calendar-date"><%= formatted_date(date) %></div>
        <ul>
          <% date_booking_dates.each do |booking_date| %>
            <li>
              <span class="calendar-slot">
                <%= booking_date.start_time %> - <%= booking_date.end_time %>
                <% if booking_date.available == false %>
                  <% if online_consultation = booking_date.online_consultations.find_by(confirmed: true) %>
                    <span class="badge bg-success"><%= online_consultation.status %></span>
                      <span><%= button_to "Cancel", online_consultation_path(online_consultation), method: :delete, class: "badge bg-danger" %></span>
                  <% end %>
                  <% if booking_date.status == "unconfirmed" %>
                    <span class="badge bg-warning"><%= booking_date.status %></span>
                  <% elsif booking_date.status == "BLOCKED"%>
                    <span class="badge bg-danger"><%= booking_date.status %></span>
                  <% end %>
                <% else %>
                  <span><%= button_to "Block Slot", booking_date_path(booking_date), method: :patch, class: "btn btn-outline-danger btn-sm" %></span>
                <% end %>
              </span>
            </li>
          <% end %>
        </ul>
      </td>

      <% if date.wday == 0 %>
        </tr>
      <% end %>
    <% end %>
  <% end %>
</table>
